var websocket,PAGENAME="",gateway=window.location.port?`ws://${window.location.hostname}:${window.location.port}/ws`:`ws://${window.location.hostname}/ws`,websck_is_connected=!1,millis_esp=0,WSCONNECTED=0,RSSI=0,isLOCAL=0,ERROR_INSTANCE=(WSCONNECTED=0,0),EN_SOUND=!1,GET_DATA_SUMAR=5;function onOpenWS(e){websck_is_connected=1,info_reboot_web(!1),setTimeout(pool_info_page,250),setTimeout(function(){checkMillis()},8e3),console.log("Connection opened")}function onCloseWS(e){websck_is_connected=0,console.log("Connection closed"),ERROR_INSTANCE||setTimeout(initWebSocket,2e3)}function initWebSocket(){console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpenWS,websocket.onclose=onCloseWS,websocket.onmessage=onMessageWS}function onMessageWS(e){var t=JSON.parse(e.data);if(1==t.hasOwnProperty("ERROR_INSTANCE"))return ERROR_INSTANCE=1,websocket.close(),t=null,alert("You have to many page opened. Keep only one in your in browser or slow down action!"),void location.replace("/protection");1==t.hasOwnProperty("cMs")&&(millis_esp=parseInt(t.cMs,10)),1==t.hasOwnProperty("Local")&&(isLOCAL=t.Local),1==t.hasOwnProperty("SIGNALPWR")&&(RSSI=t.SIGNALPWR),1==t.hasOwnProperty("wsCnt")&&(WSCONNECTED=t.wsCnt);var a=document.getElementById("idcMillis");a&&(a.innerHTML=millis_esp+" - ðŸ“¶ "+RSSI+"% ðŸ”´ LIVE ("+WSCONNECTED+")"),"dashboard"==PAGENAME&&1==t.hasOwnProperty("live_data")&&parseDashParamIndex(t),t=null}function pool_info_page(){if(!ERROR_INSTANCE&&websck_is_connected){var e={REQUEST_INFO:GET_DATA_SUMAR},t=JSON.stringify(e);websck_is_connected&&websocket.send(t),t=null,e=null,websck_is_connected&&setTimeout(function(){pool_info_page()},2e3)}}function checkMillis(){if(!ERROR_INSTANCE){var e=millis_esp;void 0===checkMillis.lastMillis&&(checkMillis.lastMillis=0),e===checkMillis.lastMillis?(info_reboot_web(!0),setTimeout(function(){window.location.reload(!0)},3e3)):(checkMillis.lastMillis=e,setTimeout(checkMillis,5e3))}}function info_reboot_web(e){switch(e){case!0:$("#idNoConnexion").removeClass("hidden"),console.log("Rebooting WebPage");break;case!1:$("#idNoConnexion").addClass("hidden")}}$(document).ready(function(){initWebSocket(),""==(PAGENAME=(PAGENAME=window.location.pathname).split("/").pop())&&(PAGENAME="index"),document.addEventListener("visibilitychange",onVisibilityChange),window.addEventListener("beforeunload",function(){document.removeEventListener("visibilitychange",onVisibilityChange)}),$("#idPlsWait").removeClass("hidden")});var confirmTimerId=null;function showConfirm(e,t,a,n){confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null);var o=document.getElementById("modalOk"),l=document.getElementById("modalCancel");if(document.getElementById("modalMsg").innerHTML=t,autoFitText(),null===n?l.classList.add("hidden"):l.classList.remove("hidden"),$("#modalConfirm").modal("show"),e>0){var i=o.textContent.replace(/\s*\[\d+\]$/,"");r(),confirmTimerId=setInterval(function(){--e>0?r():(clearInterval(confirmTimerId),confirmTimerId=null,d())},1e3)}function r(){var t=e<10?"0"+e:e;o.textContent=i+" ["+t+"]"}function s(){o.removeEventListener("click",c),l.removeEventListener("click",d),confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null)}function c(){s(),$("#modalConfirm").modal("hide"),a&&a()}function d(){s(),$("#modalConfirm").modal("hide"),n&&n()}EN_SOUND&&confirm_alert.play(),o.addEventListener("click",c),l.addEventListener("click",d)}function autoFitText(){var e=document.getElementById("modalMsg"),t=50;for(e.style.fontSize=t+"px";e.scrollWidth>e.offsetWidth&&t>20;)t--,e.style.fontSize=t+"px"}function getWeatherIconFile(e,t=!1){const a=Number(e),n=t?"_n":"",o=[{min:3,max:4,file:"furtuna"},{min:5,max:10,file:"ninsoare_ploaie"},{min:11,max:14,file:"adverse"},{min:16,max:16,file:"ninsoare"},{min:20,max:20,file:"ceata"},{min:26,max:28,file:"innorat"},{min:29,max:30,file:"insorit"},{min:31,max:34,file:"senin"},{min:37,max:38,file:"vanturi"},{min:39,max:45,file:"ploaie"},{min:46,max:47,file:"wic_thunder"}];let l="wic_unknow.png";if(0===a)l="wic_unknow.png";else for(let e of o)if(a>=e.min&&a<=e.max){l=e.file+n+".png";break}return"https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/img/weather-icon/"+l}function parseJsonWeather(e){let t={};function a(e){const t=new Date(e),a=e=>e<10?"0"+e:e,n=t.getUTCHours()+2;return t.getUTCFullYear()+"-"+a(t.getUTCMonth()+1)+"-"+a(t.getUTCDate())+"T"+a(n)+":"+a(t.getUTCMinutes())+":"+a(t.getUTCSeconds())+"+02:00"}try{t.dayCount=e.length;for(let n=0;n<e.length;n++){const o=e[n],l={};l.validDate=a(o.validDate),l.sunrise=a(o.sunrise),l.sunset=a(o.sunset),l.dayName=o.day.dayPartName,l.nightName=o.night.dayPartName,l.dayTemp=o.day.temperature,l.nightTemp=o.night.temperature,l.iconDay=String(o.day.icon);l.iconDay;l.iconNight=String(o.night.icon);l.iconNight;l.phraseDay=o.day.phrase;l.phraseDay;l.phraseNight=o.night.phrase;l.phraseNight;l.day=o.day.narrative,l.night=o.night.narrative,t[`Day${n}`]=l}}catch(e){return console.error(e),null}return t}function loadWeather(){const e=new Date;var t;$.get("http://upx83.go.ro/upx-center/wheather/upx-weather.json",function(a){if(null===(t=parseJsonWeather(a)))return void console.error("Eroare la parsarea JSON-ului");const n=new Date(t.Day0.sunrise),o=new Date(t.Day0.sunset);1==(e>n&&e<o)?($("#weatherTodayDate").html('<i class="fas fa-sun" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+t.Day0.dayName),$("#weatherTodayDayNarative").html(t.Day0.day),$("#weatherTodayIcon").attr("src",getWeatherIconFile(t.Day0.iconDay))):($("#weatherTodayDate").html('<i class="fas fa-moon" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+t.Day0.nightName),$("#weatherTodayDayNarative").html(t.Day0.night),$("#weatherTodayIcon").attr("src",getWeatherIconFile(t.Day0.iconNight),!0)),$("#weatherTodayTempDay").html(t.Day0.dayTemp),$("#weatherTodayTempNight").html(t.Day0.nightTemp),$("#weatherday1std").html(t.Day1.dayName),$("#weatherday2std").html(t.Day2.dayName),$("#weatherday3std").html(t.Day3.dayName),$("#weatherday4std").html(t.Day4.dayName),$("#weatherDate1std").html(t.Day1.validDate),$("#weatherDate2std").html(t.Day2.validDate),$("#weatherDate3std").html(t.Day3.validDate),$("#weatherDate4std").html(t.Day4.validDate),$("#narrative1Std").html(t.Day1.phraseDay),$("#narrative2Std").html(t.Day2.phraseDay),$("#narrative3Std").html(t.Day3.phraseDay),$("#narrative4Std").html(t.Day4.phraseDay),$("#temp1Std").html(t.Day1.dayTemp+"Âº"),$("#temp2Std").html(t.Day2.dayTemp+"Âº"),$("#temp3Std").html(t.Day3.dayTemp+"Âº"),$("#temp4Std").html(t.Day4.dayTemp+"Âº"),$("#icon1Std").attr("src",getWeatherIconFile(t.Day1.iconDay)),$("#icon2Std").attr("src",getWeatherIconFile(t.Day2.iconDay)),$("#icon3Std").attr("src",getWeatherIconFile(t.Day3.iconDay)),$("#icon4Std").attr("src",getWeatherIconFile(t.Day4.iconDay))})}function parseDashParamIndex(e){if(null!=e){var t=e.live_data,a="";$("#lbl_dormitor_temp").html(t.TEMP_DORMITOR+"<label>ÂºC</label>"),$("#lbl_dormitor2_temp").html(t.TEMP_DORMITOR2+"<label>ÂºC</label>"),$("#lbl_living_temp").html(t.TEMP_HOL+"<label>ÂºC</label>"),$("#lbl_ext_temp").html(t.TEMP_EXTERN+"<label>ÂºC</label>"),$("#lbl_matrix_temp").html(temp_resimtita(parseFloat(t.MATRIX_INDOOR),parseFloat(t.HOL_HUMIDITY),.2)+"<label>ÂºC</label>"),$("#lbl_thermostatset_temp").html(t.THERMOSTAT+"<label>ÂºC</label>"),0==t.CentralaOn?$("#heaton_icon").addClass("invisible"):$("#heaton_icon").removeClass("invisible"),a=checkValueForBlink(t.CALOR1_VCC,2100,3300),$("#CALOR1_VCC").html('<div class="'+a+'">'+t.CALOR1_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR2_VCC,2100,3300),$("#CALOR2_VCC").html('<div class="'+a+'">'+t.CALOR2_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR3_VCC,2100,3300),$("#CALOR3_VCC").html('<div class="'+a+'">'+t.CALOR3_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR4_VCC,2100,3300),$("#CALOR4_VCC").html('<div class="'+a+'">'+t.CALOR4_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR5_VCC,2100,3300),$("#CALOR5_VCC").html('<div class="'+a+'">'+t.CALOR5_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR6_VCC,2100,3300),$("#CALOR6_VCC").html('<div class="'+a+'">'+t.CALOR6_VCC+"mV</div>"),$("#CALOR1_CUR_STATE").html(decodeCalorMode(t.CALOR1_CUR_STATE)),$("#CALOR2_CUR_STATE").html(decodeCalorMode(t.CALOR2_CUR_STATE)),$("#CALOR3_CUR_STATE").html(decodeCalorMode(t.CALOR3_CUR_STATE)),$("#CALOR4_CUR_STATE").html(decodeCalorMode(t.CALOR4_CUR_STATE)),$("#CALOR5_CUR_STATE").html(decodeCalorMode(t.CALOR5_CUR_STATE)),$("#CALOR6_CUR_STATE").html(decodeCalorMode(t.CALOR6_CUR_STATE)),$("#CALOR1_SET_STATE").html(decodeCalorMode(t.CALOR1_SET_STATE)),$("#CALOR2_SET_STATE").html(decodeCalorMode(t.CALOR2_SET_STATE)),$("#CALOR3_SET_STATE").html(decodeCalorMode(t.CALOR3_SET_STATE)),$("#CALOR4_SET_STATE").html(decodeCalorMode(t.CALOR4_SET_STATE)),$("#CALOR5_SET_STATE").html(decodeCalorMode(t.CALOR5_SET_STATE)),$("#CALOR6_SET_STATE").html(decodeCalorMode(t.CALOR6_SET_STATE)),$("#lbl_umid_exterior").html(t.HUMIDITY_EXT+"<label>%</label>"),$("#lbl_umid_interior").html(t.HOL_HUMIDITY+"<label>%</label>"),$("#lbl_jal_raw").html(t.jalAutoModeRun+"<label>lx</label>"),$("#lbl_jalmode").html(decodeJalModeNow(t.jalModeNow)),$("#lbl_ldr_exterior").html(t.outdoorLDR+"<label>LX</label>"),$("#lbl_ldr_interior").html(t.dormitorLDR+"<label>LX</label>"),$("#lbl_battery").html(t.VOLTAGE_BATTERY+"<label>V</label>"),$("#lbl_12V").html(t.VOLTAGE_RAIL12+"<label>V</label>"),$("#lbl_mainsupply").html(t.VOLTAGE_MAIN+"<label>V</label>"),$("#totalHeatTime").html(t.totalHeatTime),$("#lastHeatTime").html(t.tmLstHeatChg),$("#heatingState").html(t.CentralaOn?"ON":"OFF"),$("#idPlsWait").addClass("hidden")}}function decodeJalModeNow(e){switch(e){case 0:return"MANUAL";case 1:return"AUTO";case 2:return"USER LDR";default:return e}}function decodeCalorMode(e){switch(e){case 0:return"<div>NEDEFINIT</div>";case 1:return'<div class="green">DESCHIS</div>';case 2:return'<div class = "red">INCHIS</div>'}}function checkValueForBlink(e,t,a){var n=parseFloat(e);return n<t||n>a?"blink":""}function temp_resimtita(e,t,a){return parseFloat(e+t/100*.33*6.105*Math.exp(17.27*e/(237.7+e))-.7*a-4).toFixed(2)}function onVisibilityChange(){ERROR_INSTANCE=1,websocket.close(),location.replace("/protection")}function forceToEnableSND(){EN_SOUND||(console.log("Try to enable SND..."),showConfirm(30,"Activati sunetul in sistem pentru Alerte",function(){info.play(),info.pause(),short_info.play(),short_info.pause(),confirm_alert.play(),confirm_alert.pause(),EN_SOUND=!0,console.log("Enable SND in SYSTEM")},null),setTimeout(function(){forceToEnableSND()},6e4))}$("#btn_turbo").on("click",function(e){setInterval(function(){showConfirm(10,"Aceasta este o alerta <br> Acesta este randul doi<br>Randul trei",null,null)},2e4)}),setTimeout(function(){var e=document.createElement("script");e.src="https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/sound_library.js",document.body.appendChild(e),e.onload=function(){console.log("sound_library OK"),forceToEnableSND(),loadWeather()}},1e3);