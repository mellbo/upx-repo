var websocket,DEBUG=0,PAGENAME="",gateway="ws://"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/ws",websck_is_connected=!1,websck_auto_disconected=!1,millis_esp=0,WSCONNECTED=0,RSSI=0,isLOCAL=0,EN_SOUND=!1,zCtrlWeatherID=-1,LAST_ERRID=-1,ERRLST_EXTERMAL=null,isIPAD="iPad"===navigator.platform,RETRYCNT=0,GET_DATA_SUMAR=5;function closingWS(){DEBUG&&console.log("closingWS.."),websck_is_connected=0,websocket&&websocket.readyState===WebSocket.OPEN&&(websocket.onopen=null,websocket.onclose=null,websocket.onmessage=null,websocket.onerror=null,websocket.close(1e3,"client close"),websocket=null),setTimeout(function(){initWebSocket()},3e3),setTimeout(function(){websocket&&websocket.readyState===WebSocket.OPEN||(RETRYCNT++,$("#idRETRYCNT").text("Retry #"+RETRYCNT),closingWS())},1e4)}function onOpenWS(e){RETRYCNT=0,websck_is_connected=1,websck_auto_disconected=!1,info_reboot_web(!1),setTimeout(pool_info_page,250),setTimeout(function(){checkMillis()},8e3),DEBUG&&console.log("Connection opened")}function onCloseWS(e){websck_auto_disconected=!0,DEBUG&&console.log("Connection remote closed")}function initWebSocket(){(!websocket||websocket.readyState!==WebSocket.OPEN&&websocket.readyState!==WebSocket.CONNECTING)&&(DEBUG&&console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpenWS,websocket.onclose=onCloseWS,websocket.onmessage=onMessageWS)}function onMessageWS(e){var t=JSON.parse(e.data);if(DEBUG&&console.log(t),1==t.hasOwnProperty("ERROR_INSTANCE"))return t=null,EN_SOUND&&myfavInfo.play(),DEBUG&&console.log("You have to many page opened. Keep only one in your in browser or slow down action!"),void closingWS();1==t.hasOwnProperty("cMs")&&(millis_esp=parseInt(t.cMs,10)),1==t.hasOwnProperty("Local")&&(isLOCAL=t.Local),1==t.hasOwnProperty("SIGNALPWR")&&(RSSI=t.SIGNALPWR),1==t.hasOwnProperty("wsCnt")&&(WSCONNECTED=t.wsCnt);var o=document.getElementById("idcMillis");if(o&&(o.innerHTML=millis_esp+" - ðŸ“¶ "+RSSI+"% ðŸ”´ LIVE ("+WSCONNECTED+")"),"dashboard"==PAGENAME&&(1==t.hasOwnProperty("live_data")&&parseDashParamIndex(t),null!==ERRLST_EXTERMAL&&1==t.hasOwnProperty("ERRLST_IDX"))){var a=parseInt(t.ERRLST_IDX,10);if(LAST_ERRID!=a){LAST_ERRID=a;var n=ERRLST_EXTERMAL[a];showInfoAutoClose(n>=2&&n<=9?60:20,!0,n,null,null)}}t=null}function pool_info_page(){if(websck_is_connected&&!websck_auto_disconected){var e={REQUEST_INFO:GET_DATA_SUMAR},t=JSON.stringify(e);websck_is_connected&&websocket.send(t),t=null,e=null,websck_is_connected&&setTimeout(function(){pool_info_page()},2e3)}}function checkMillis(){var e=millis_esp;if(void 0===checkMillis.lastMillis&&(checkMillis.lastMillis=0),e===checkMillis.lastMillis)info_reboot_web(!0),websck_is_connected=0,closingWS();else{checkMillis.lastMillis=e;setTimeout(checkMillis,5e3)}}$(document).ready(function(){if(isIPAD&&window.location.search.length>1){var e=getParam("autoReboot"),t=null;if(null===e||isNaN(e)||(t=parseInt(e,10)),null!==t&&1==t){var o=new Date,a=("0"+o.getDate()).slice(-2)+"."+("0"+(o.getMonth()+1)).slice(-2)+"."+o.getFullYear()+" "+("0"+o.getHours()).slice(-2)+":"+("0"+o.getMinutes()).slice(-2)+":"+("0"+o.getSeconds()).slice(-2);setTimeout(function(){showInfoAutoClose(0,!0,"AutoReboot at: "+a,null,null)},3e4)}}initWebSocket(),""==(PAGENAME=(PAGENAME=window.location.pathname).split("/").pop())&&(PAGENAME="index"),document.addEventListener("visibilitychange",onVisibilityChange),window.addEventListener("beforeunload",function(){document.removeEventListener("visibilitychange",onVisibilityChange)}),checkDevice(),$("#idPlsWait").removeClass("hidden"),setTimeout(function(){null==ERRLST_EXTERMAL&&LoadERRLST_EXTERMAL()},2e3)});var infoRebootFlag=!1;function info_reboot_web(e){switch(e){case!0:infoRebootFlag||($("#idNoConnexion").removeClass("hidden"),DEBUG&&console.log("Rebooting WebPage"),infoRebootFlag=!0);break;case!1:infoRebootFlag&&($("#idNoConnexion").addClass("hidden"),$("#idRETRYCNT").text(""),infoRebootFlag=!1)}}var confirmTimerId=null;function showInfoAutoClose(e,t,o,a,n){confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null);var l=document.getElementById("btnOkInfoAutoClose"),i=document.getElementById("btnCancelInfoAutoClose");if(document.getElementById("lblInfoAutoClose").innerHTML=o,autoFitText(),null===n?i.classList.add("hidden"):i.classList.remove("hidden"),$("#modalInfoAutoClose").modal("show"),e>0){var r=l.textContent.replace(/\s*\[\d+\]$/,"");s(),confirmTimerId=setInterval(function(){--e>0?s():(clearInterval(confirmTimerId),confirmTimerId=null,m())},1e3)}function s(){var t=e<10?"0"+e:e;l.textContent=r+" ["+t+"]"}function c(){l.removeEventListener("click",d),i.removeEventListener("click",m),confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null)}function d(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),a&&a()}function m(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),n&&n()}EN_SOUND&&t&&myfavInfo.play(),l.addEventListener("click",d),i.addEventListener("click",m)}function autoFitText(){var e=document.getElementById("lblInfoAutoClose"),t=50;for(e.style.fontSize=t+"px";e.scrollWidth>e.offsetWidth&&t>20;)t--,e.style.fontSize=t+"px"}function getWeatherIconFile(e,t){void 0===t&&(t=!1);var o=Number(e),a=t?"_n":"",n=[{min:3,max:4,file:"furtuna"},{min:5,max:10,file:"ninsoare_ploaie"},{min:11,max:14,file:"adverse"},{min:16,max:16,file:"ninsoare"},{min:20,max:20,file:"ceata"},{min:26,max:28,file:"innorat"},{min:29,max:30,file:"insorit"},{min:31,max:34,file:"senin"},{min:37,max:38,file:"vanturi"},{min:39,max:45,file:"ploaie"},{min:46,max:47,file:"wic_thunder"}],l="wic_unknow.png";if(0===o)l="wic_unknow.png";else for(var i=0;i<n.length;i++){var r=n[i];if(o>=r.min&&o<=r.max){l=r.file+a+".png";break}}return"https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/img/weather-icon/"+l}function parseJsonWeather(e){var t={};function o(e){var t=new Date(e);function o(e){return e<10?"0"+e:e}return o(t.getDate())+"."+o(t.getMonth()+1)+"."+t.getFullYear()+" "+o(t.getHours())+":"+o(t.getMinutes())+":"+o(t.getSeconds())}try{t.dayCount=e.length;for(var a=0;a<e.length;a++){var n=e[a],l={};l.validDate=o(n.validDate),l.sunrise=n.sunrise,l.sunset=n.sunset,l.dayName=n.day.dayPartName,l.nightName=n.night.dayPartName,l.dayTemp=n.day.temperature,l.nightTemp=n.night.temperature,l.iconDay=String(n.day.icon);l.iconDay;l.iconNight=String(n.night.icon);l.iconNight;l.phraseDay=n.day.phrase;l.phraseDay;l.phraseNight=n.night.phrase;l.phraseNight;l.day=n.day.narrative,l.night=n.night.narrative,t["Day"+a]=l}}catch(e){return DEBUG&&console.error(e),null}return t}function loadWeather(){var e,t=new Date;$.ajax({url:"http://upx83.go.ro/upx-center/wheather/upx-weather.json",method:"GET",dataType:"json",timeout:5e3,success:function(o){if(null===(e=parseJsonWeather(o)))return void(DEBUG&&console.error("Eroare la parsarea JSON-ului"));const a=new Date(e.Day0.sunrise),n=new Date(e.Day0.sunset);1==(t>a&&t<n)?($("#weatherTodayDate").html('<i class="fas fa-sun" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+e.Day0.dayName),$("#weatherTodayDayNarative").html(e.Day0.day),$("#weatherTodayIcon").attr("src",getWeatherIconFile(e.Day0.iconDay,!1))):($("#weatherTodayDate").html('<i class="fas fa-moon" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+e.Day0.nightName),$("#weatherTodayDayNarative").html(e.Day0.night),$("#weatherTodayIcon").attr("src",getWeatherIconFile(e.Day0.iconNight,!0))),$("#weatherTodayTempDay").html(e.Day0.dayTemp),$("#weatherTodayTempNight").html(e.Day0.nightTemp),$("#weatherday1std").html(e.Day1.dayName),$("#weatherday2std").html(e.Day2.dayName),$("#weatherday3std").html(e.Day3.dayName),$("#weatherday4std").html(e.Day4.dayName),$("#weatherDate1std").html(e.Day1.validDate),$("#weatherDate2std").html(e.Day2.validDate),$("#weatherDate3std").html(e.Day3.validDate),$("#weatherDate4std").html(e.Day4.validDate),$("#narrative1Std").html(e.Day1.phraseDay),$("#narrative2Std").html(e.Day2.phraseDay),$("#narrative3Std").html(e.Day3.phraseDay),$("#narrative4Std").html(e.Day4.phraseDay),$("#temp1Std").html(e.Day1.dayTemp+"Âº"),$("#temp2Std").html(e.Day2.dayTemp+"Âº"),$("#temp3Std").html(e.Day3.dayTemp+"Âº"),$("#temp4Std").html(e.Day4.dayTemp+"Âº"),$("#icon1Std").attr("src",getWeatherIconFile(e.Day1.iconDay)),$("#icon2Std").attr("src",getWeatherIconFile(e.Day2.iconDay)),$("#icon3Std").attr("src",getWeatherIconFile(e.Day3.iconDay)),$("#icon4Std").attr("src",getWeatherIconFile(e.Day4.iconDay)),DEBUG&&console.log("Load weather.")},error:function(e,t,o){DEBUG&&console.error("Eroare la loadWeather:",t,o)}})}function parseDashParamIndex(e){if(null!=e){var t=e.live_data,o="";$("#lbl_dormitor_temp").html(t.TEMP_DORMITOR+"<label>ÂºC</label>"),$("#lbl_dormitor2_temp").html(t.TEMP_DORMITOR2+"<label>ÂºC</label>"),$("#lbl_living_temp").html(t.TEMP_HOL+"<label>ÂºC</label>"),$("#lbl_ext_temp").html(t.TEMP_EXTERN+"<label>ÂºC</label>"),$("#lbl_matrix_temp").html(t.MATRIX_INDOOR+"<label>ÂºC</label>"),$("#lbl_thermostatset_temp").html(t.THERMOSTAT+"<label>ÂºC</label>"),0==t.LOGS_HAVE_ERR?$("#idLogErrorAlert").addClass("invisible"):$("#idLogErrorAlert").removeClass("invisible"),0==t.CentralaOn?$("#heaton_icon").addClass("invisible"):$("#heaton_icon").removeClass("invisible"),1==t.THERMOSTATFORCE24?($("#info_turbo").removeClass("force24Off"),$("#info_turbo").addClass("force24On")):($("#info_turbo").removeClass("force24On"),$("#info_turbo").addClass("force24Off")),o=checkValueForBlink(t.CALOR1_VCC,2100,3300),$("#CALOR1_VCC").html('<div class="'+o+'">'+t.CALOR1_VCC+"mV</div>"),o=checkValueForBlink(t.CALOR2_VCC,2100,3300),$("#CALOR2_VCC").html('<div class="'+o+'">'+t.CALOR2_VCC+"mV</div>"),o=checkValueForBlink(t.CALOR3_VCC,2100,3300),$("#CALOR3_VCC").html('<div class="'+o+'">'+t.CALOR3_VCC+"mV</div>"),o=checkValueForBlink(t.CALOR4_VCC,2100,3300),$("#CALOR4_VCC").html('<div class="'+o+'">'+t.CALOR4_VCC+"mV</div>"),o=checkValueForBlink(t.CALOR5_VCC,2100,3300),$("#CALOR5_VCC").html('<div class="'+o+'">'+t.CALOR5_VCC+"mV</div>"),o=checkValueForBlink(t.CALOR6_VCC,2100,3300),$("#CALOR6_VCC").html('<div class="'+o+'">'+t.CALOR6_VCC+"mV</div>"),$("#CALOR1_CUR_STATE").html(decodeCalorMode(t.CALOR1_CUR_STATE)),$("#CALOR2_CUR_STATE").html(decodeCalorMode(t.CALOR2_CUR_STATE)),$("#CALOR3_CUR_STATE").html(decodeCalorMode(t.CALOR3_CUR_STATE)),$("#CALOR4_CUR_STATE").html(decodeCalorMode(t.CALOR4_CUR_STATE)),$("#CALOR5_CUR_STATE").html(decodeCalorMode(t.CALOR5_CUR_STATE)),$("#CALOR6_CUR_STATE").html(decodeCalorMode(t.CALOR6_CUR_STATE)),$("#CALOR1_SET_STATE").html(decodeCalorMode(t.CALOR1_SET_STATE)),$("#CALOR2_SET_STATE").html(decodeCalorMode(t.CALOR2_SET_STATE)),$("#CALOR3_SET_STATE").html(decodeCalorMode(t.CALOR3_SET_STATE)),$("#CALOR4_SET_STATE").html(decodeCalorMode(t.CALOR4_SET_STATE)),$("#CALOR5_SET_STATE").html(decodeCalorMode(t.CALOR5_SET_STATE)),$("#CALOR6_SET_STATE").html(decodeCalorMode(t.CALOR6_SET_STATE)),$("#lbl_umid_exterior").html(t.HUMIDITY_EXT+"<label>%</label>"),$("#lbl_umid_interior").html(t.HOL_HUMIDITY+"<label>%</label>"),$("#lbl_jal_raw").html(t.jalAutoModeWeb+"<label>lx</label>"),$("#lbl_jalmode").html(decodeJalModeNow(t.jalModeNow)),$("#lbl_ldr_exterior").html(t.outdoorLDR+"<label>LX</label>"),$("#lbl_ldr_interior").html(t.dormitorLDR+"<label>LX</label>"),$("#lbl_battery").html(t.VOLTAGE_BATTERY+"<label>V</label>"),$("#lbl_12V").html(t.VOLTAGE_RAIL12+"<label>V</label>"),$("#lbl_mainsupply").html(t.VOLTAGE_MAIN+"<label>V</label>"),$("#totalHeatTime").html(secToDateTimeStr(t.totalHeatTime)),$("#lastHeatTime").html(t.tmLstHeatChg),$("#heatingState").html(t.CentralaOn?"ON":"OFF"),$("#idPlsWait").addClass("hidden");var a=parseInt(t.zCtrlWeatherID,10);a!=zCtrlWeatherID&&(zCtrlWeatherID=a,loadWeather())}}function decodeJalModeNow(e){switch(e){case 0:return"MANUAL";case 1:return"AUTO";case 2:return"USER LDR";default:return e}}function decodeCalorMode(e){switch(e){case 0:return"<div>NEDEFINIT</div>";case 1:return'<div class="green">DESCHIS</div>';case 2:return'<div class = "red">INCHIS</div>'}}function checkValueForBlink(e,t,o){var a=parseFloat(e);return a<t||a>o?"blink":""}function temp_resimtita(e,t,o){return parseFloat(e+t/100*.33*6.105*Math.exp(17.27*e/(237.7+e))-.7*o-4).toFixed(2)}function onVisibilityChange(){websck_is_connected=0,websocket.close(),location.replace("/protection?loc="+PAGENAME+"&timer=0")}function secToDateTimeStr(e){if("number"!=typeof e||isNaN(e))return"Invalid";var t=Math.floor(e/86400),o=e%86400,a=Math.floor(o/3600);o%=3600;var n=Math.floor(o/60),l=o%60;function i(e){return e<10?"0"+e:e}var r="";return t>0&&(r+=t+"D "),r+=i(a)+":"+i(n)+":"+i(l)}function forceToEnableSND(){EN_SOUND||(DEBUG&&console.log("Try to enable SND..."),showInfoAutoClose(30,!1,"Activati sunetul in sistem pentru Alerte",function(){sndBtnClick.play(),sndBtnClick.pause(),myfavInfo.play(),myfavInfo.pause(),EN_SOUND=!0,DEBUG&&console.log("Enable SND in SYSTEM")},null),setTimeout(function(){forceToEnableSND()},6e4))}function loadPageNonBlocking(e,t){var o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){var e=JSON.parse(o.responseText);document.getElementById("idReloadWheater").innerHTML="[<b>"+e[0]+"</b>]: "+e[1],DEBUG&&console.log(e),setTimeout(function(){loadWeather()},1e3)}},o.send("runWeather=1"),setTimeout(function(){o.abort()},t)}function LoadERRLST_EXTERMAL(){try{var e=new XMLHttpRequest;if(e.open("GET","https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/ERRLST.lst",!1),e.send(null),200!==e.status)return void(DEBUG&&console.log("ERRLST_EXTERMAL: can`t load"));var t=e.responseText;ERRLST_EXTERMAL=new Function("return "+t)(),DEBUG&&console.log("ERRLST_EXTERMAL Loaded OK")}catch(e){return void(DEBUG&&console.log("ERRLST_EXTERMAL Err: ",e.message))}}function checkDevice(){!1!==window.oldDevice&&$(".clsDevForOld").addClass("clsDevOld disabled").find("a").on("click",function(e){e.preventDefault()})}function getParam(e){for(var t=window.location.search.substring(1).split("&"),o=0;o<t.length;o++){var a=t[o].split("=");if(a[0]===e&&a.length>1)return decodeURIComponent(a[1])}return null}$("#idReloadWheater").on("click",function(e){loadPageNonBlocking("http://upx83.go.ro/upx-center/wheather/vremea.php",5e3)}),setTimeout(function(){var e=document.createElement("script");e.src="https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/sound_library.js",document.body.appendChild(e),e.onload=function(){DEBUG&&console.log("sound_library OK"),forceToEnableSND()}},1e3);