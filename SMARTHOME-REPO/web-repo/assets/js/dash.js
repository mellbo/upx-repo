var websocket,DEBUG=1,PAGENAME="",gateway=window.location.port?`ws://${window.location.hostname}:${window.location.port}/ws`:`ws://${window.location.hostname}/ws`,websck_is_connected=!1,millis_esp=0,WSCONNECTED=0,RSSI=0,isLOCAL=0,ERROR_INSTANCE=(WSCONNECTED=0,0),EN_SOUND=!1,zCtrlWeatherID=-1,LAST_ERRID=-1,ERRLST_EXTERMAL=null,GET_DATA_SUMAR=5;function onOpenWS(e){websck_is_connected=1,info_reboot_web(!1),setTimeout(pool_info_page,250),setTimeout(function(){checkMillis()},8e3),DEBUG&&console.log("Connection opened")}function onCloseWS(e){websck_is_connected=0,DEBUG&&console.log("Connection closed"),ERROR_INSTANCE||setTimeout(initWebSocket,2e3)}function initWebSocket(){DEBUG&&console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpenWS,websocket.onclose=onCloseWS,websocket.onmessage=onMessageWS}function onMessageWS(e){var t=JSON.parse(e.data);if(DEBUG&&console.log(t),1==t.hasOwnProperty("ERROR_INSTANCE"))return ERROR_INSTANCE=1,websocket.close(),t=null,alert("You have to many page opened. Keep only one in your in browser or slow down action!"),void location.replace("/protection");1==t.hasOwnProperty("cMs")&&(millis_esp=parseInt(t.cMs,10)),1==t.hasOwnProperty("Local")&&(isLOCAL=t.Local),1==t.hasOwnProperty("SIGNALPWR")&&(RSSI=t.SIGNALPWR),1==t.hasOwnProperty("wsCnt")&&(WSCONNECTED=t.wsCnt);var a=document.getElementById("idcMillis");if(a&&(a.innerHTML=millis_esp+" - ðŸ“¶ "+RSSI+"% ðŸ”´ LIVE ("+WSCONNECTED+")"),"dashboard"==PAGENAME&&(1==t.hasOwnProperty("live_data")&&parseDashParamIndex(t),null!==ERRLST_EXTERMAL&&1==t.hasOwnProperty("ERRLST_IDX"))){var o=parseInt(t.ERRLST_IDX,10);if(LAST_ERRID!=o)LAST_ERRID=o,showInfoAutoClose(10,!0,ERRLST_EXTERMAL[o],!1,null,null)}t=null}function pool_info_page(){if(!ERROR_INSTANCE&&websck_is_connected){var e={REQUEST_INFO:GET_DATA_SUMAR},t=JSON.stringify(e);websck_is_connected&&websocket.send(t),t=null,e=null,websck_is_connected&&setTimeout(function(){pool_info_page()},2e3)}}function checkMillis(){if(!ERROR_INSTANCE){var e=millis_esp;void 0===checkMillis.lastMillis&&(checkMillis.lastMillis=0),e===checkMillis.lastMillis?(info_reboot_web(!0),setTimeout(function(){window.location.reload(!0)},3e3)):(checkMillis.lastMillis=e,setTimeout(checkMillis,5e3))}}function info_reboot_web(e){switch(e){case!0:$("#idNoConnexion").removeClass("hidden"),DEBUG&&console.log("Rebooting WebPage");break;case!1:$("#idNoConnexion").addClass("hidden")}}$(document).ready(function(){initWebSocket(),""==(PAGENAME=(PAGENAME=window.location.pathname).split("/").pop())&&(PAGENAME="index"),document.addEventListener("visibilitychange",onVisibilityChange),window.addEventListener("beforeunload",function(){document.removeEventListener("visibilitychange",onVisibilityChange)}),$("#idPlsWait").removeClass("hidden"),setTimeout(function(){null==ERRLST_EXTERMAL&&LoadERRLST_EXTERMAL()},2e3)});var confirmTimerId=null;function showInfoAutoClose(e,t,a,o,n){confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null);var l=document.getElementById("btnOkInfoAutoClose"),i=document.getElementById("btnCancelInfoAutoClose");if(document.getElementById("lblInfoAutoClose").innerHTML=a,autoFitText(),null===n?i.classList.add("hidden"):i.classList.remove("hidden"),$("#modalInfoAutoClose").modal("show"),e>0){var r=l.textContent.replace(/\s*\[\d+\]$/,"");s(),confirmTimerId=setInterval(function(){--e>0?s():(clearInterval(confirmTimerId),confirmTimerId=null,m())},1e3)}function s(){var t=e<10?"0"+e:e;l.textContent=r+" ["+t+"]"}function c(){l.removeEventListener("click",d),i.removeEventListener("click",m),confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null)}function d(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),o&&o()}function m(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),n&&n()}EN_SOUND&&t&&confirm_alert.play(),l.addEventListener("click",d),i.addEventListener("click",m)}function autoFitText(){var e=document.getElementById("lblInfoAutoClose"),t=50;for(e.style.fontSize=t+"px";e.scrollWidth>e.offsetWidth&&t>20;)t--,e.style.fontSize=t+"px"}function getWeatherIconFile(e,t){void 0===t&&(t=!1);var a=Number(e),o=t?"_n":"",n=[{min:3,max:4,file:"furtuna"},{min:5,max:10,file:"ninsoare_ploaie"},{min:11,max:14,file:"adverse"},{min:16,max:16,file:"ninsoare"},{min:20,max:20,file:"ceata"},{min:26,max:28,file:"innorat"},{min:29,max:30,file:"insorit"},{min:31,max:34,file:"senin"},{min:37,max:38,file:"vanturi"},{min:39,max:45,file:"ploaie"},{min:46,max:47,file:"wic_thunder"}],l="wic_unknow.png";if(0===a)l="wic_unknow.png";else for(var i=0;i<n.length;i++){var r=n[i];if(a>=r.min&&a<=r.max){l=r.file+o+".png";break}}return"https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/img/weather-icon/"+l}function parseJsonWeather(e){var t={};function a(e){var t=new Date(e);function a(e){return e<10?"0"+e:e}return a(t.getDate())+"."+a(t.getMonth()+1)+"."+t.getFullYear()+" "+a(t.getHours())+":"+a(t.getMinutes())+":"+a(t.getSeconds())}try{t.dayCount=e.length;for(var o=0;o<e.length;o++){var n=e[o],l={};l.validDate=a(n.validDate),l.sunrise=n.sunrise,l.sunset=n.sunset,l.dayName=n.day.dayPartName,l.nightName=n.night.dayPartName,l.dayTemp=n.day.temperature,l.nightTemp=n.night.temperature,l.iconDay=String(n.day.icon);l.iconDay;l.iconNight=String(n.night.icon);l.iconNight;l.phraseDay=n.day.phrase;l.phraseDay;l.phraseNight=n.night.phrase;l.phraseNight;l.day=n.day.narrative,l.night=n.night.narrative,t["Day"+o]=l}}catch(e){return DEBUG&&console.error(e),null}return t}function loadWeather(){var e,t=new Date;$.ajax({url:"http://upx83.go.ro/upx-center/wheather/upx-weather.json",method:"GET",dataType:"json",timeout:5e3,success:function(a){if(null===(e=parseJsonWeather(a)))return void(DEBUG&&console.error("Eroare la parsarea JSON-ului"));const o=new Date(e.Day0.sunrise),n=new Date(e.Day0.sunset);1==(t>o&&t<n)?($("#weatherTodayDate").html('<i class="fas fa-sun" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+e.Day0.dayName),$("#weatherTodayDayNarative").html(e.Day0.day),$("#weatherTodayIcon").attr("src",getWeatherIconFile(e.Day0.iconDay,!1))):($("#weatherTodayDate").html('<i class="fas fa-moon" id="weatherTodayDateIcon" style="font-size: 17px; margin: 11px;"></i>'+e.Day0.nightName),$("#weatherTodayDayNarative").html(e.Day0.night),$("#weatherTodayIcon").attr("src",getWeatherIconFile(e.Day0.iconNight,!0))),$("#weatherTodayTempDay").html(e.Day0.dayTemp),$("#weatherTodayTempNight").html(e.Day0.nightTemp),$("#weatherday1std").html(e.Day1.dayName),$("#weatherday2std").html(e.Day2.dayName),$("#weatherday3std").html(e.Day3.dayName),$("#weatherday4std").html(e.Day4.dayName),$("#weatherDate1std").html(e.Day1.validDate),$("#weatherDate2std").html(e.Day2.validDate),$("#weatherDate3std").html(e.Day3.validDate),$("#weatherDate4std").html(e.Day4.validDate),$("#narrative1Std").html(e.Day1.phraseDay),$("#narrative2Std").html(e.Day2.phraseDay),$("#narrative3Std").html(e.Day3.phraseDay),$("#narrative4Std").html(e.Day4.phraseDay),$("#temp1Std").html(e.Day1.dayTemp+"Âº"),$("#temp2Std").html(e.Day2.dayTemp+"Âº"),$("#temp3Std").html(e.Day3.dayTemp+"Âº"),$("#temp4Std").html(e.Day4.dayTemp+"Âº"),$("#icon1Std").attr("src",getWeatherIconFile(e.Day1.iconDay)),$("#icon2Std").attr("src",getWeatherIconFile(e.Day2.iconDay)),$("#icon3Std").attr("src",getWeatherIconFile(e.Day3.iconDay)),$("#icon4Std").attr("src",getWeatherIconFile(e.Day4.iconDay))},error:function(e,t,a){DEBUG&&console.error("Eroare la loadWeather:",t,a)}})}function parseDashParamIndex(e){if(null!=e){var t=e.live_data,a="";$("#lbl_dormitor_temp").html(t.TEMP_DORMITOR+"<label>ÂºC</label>"),$("#lbl_dormitor2_temp").html(t.TEMP_DORMITOR2+"<label>ÂºC</label>"),$("#lbl_living_temp").html(t.TEMP_HOL+"<label>ÂºC</label>"),$("#lbl_ext_temp").html(t.TEMP_EXTERN+"<label>ÂºC</label>"),$("#lbl_matrix_temp").html(temp_resimtita(parseFloat(t.MATRIX_INDOOR),parseFloat(t.HOL_HUMIDITY),.2)+"<label>ÂºC</label>"),$("#lbl_thermostatset_temp").html(t.THERMOSTAT+"<label>ÂºC</label>"),0==t.CentralaOn?$("#heaton_icon").addClass("invisible"):$("#heaton_icon").removeClass("invisible"),a=checkValueForBlink(t.CALOR1_VCC,2100,3300),$("#CALOR1_VCC").html('<div class="'+a+'">'+t.CALOR1_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR2_VCC,2100,3300),$("#CALOR2_VCC").html('<div class="'+a+'">'+t.CALOR2_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR3_VCC,2100,3300),$("#CALOR3_VCC").html('<div class="'+a+'">'+t.CALOR3_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR4_VCC,2100,3300),$("#CALOR4_VCC").html('<div class="'+a+'">'+t.CALOR4_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR5_VCC,2100,3300),$("#CALOR5_VCC").html('<div class="'+a+'">'+t.CALOR5_VCC+"mV</div>"),a=checkValueForBlink(t.CALOR6_VCC,2100,3300),$("#CALOR6_VCC").html('<div class="'+a+'">'+t.CALOR6_VCC+"mV</div>"),$("#CALOR1_CUR_STATE").html(decodeCalorMode(t.CALOR1_CUR_STATE)),$("#CALOR2_CUR_STATE").html(decodeCalorMode(t.CALOR2_CUR_STATE)),$("#CALOR3_CUR_STATE").html(decodeCalorMode(t.CALOR3_CUR_STATE)),$("#CALOR4_CUR_STATE").html(decodeCalorMode(t.CALOR4_CUR_STATE)),$("#CALOR5_CUR_STATE").html(decodeCalorMode(t.CALOR5_CUR_STATE)),$("#CALOR6_CUR_STATE").html(decodeCalorMode(t.CALOR6_CUR_STATE)),$("#CALOR1_SET_STATE").html(decodeCalorMode(t.CALOR1_SET_STATE)),$("#CALOR2_SET_STATE").html(decodeCalorMode(t.CALOR2_SET_STATE)),$("#CALOR3_SET_STATE").html(decodeCalorMode(t.CALOR3_SET_STATE)),$("#CALOR4_SET_STATE").html(decodeCalorMode(t.CALOR4_SET_STATE)),$("#CALOR5_SET_STATE").html(decodeCalorMode(t.CALOR5_SET_STATE)),$("#CALOR6_SET_STATE").html(decodeCalorMode(t.CALOR6_SET_STATE)),$("#lbl_umid_exterior").html(t.HUMIDITY_EXT+"<label>%</label>"),$("#lbl_umid_interior").html(t.HOL_HUMIDITY+"<label>%</label>"),$("#lbl_jal_raw").html(t.jalAutoModeRun+"<label>lx</label>"),$("#lbl_jalmode").html(decodeJalModeNow(t.jalModeNow)),$("#lbl_ldr_exterior").html(t.outdoorLDR+"<label>LX</label>"),$("#lbl_ldr_interior").html(t.dormitorLDR+"<label>LX</label>"),$("#lbl_battery").html(t.VOLTAGE_BATTERY+"<label>V</label>"),$("#lbl_12V").html(t.VOLTAGE_RAIL12+"<label>V</label>"),$("#lbl_mainsupply").html(t.VOLTAGE_MAIN+"<label>V</label>"),$("#totalHeatTime").html(t.totalHeatTime),$("#lastHeatTime").html(t.tmLstHeatChg),$("#heatingState").html(t.CentralaOn?"ON":"OFF"),$("#idPlsWait").addClass("hidden");var o=parseInt(t.zCtrlWeatherID,10);o!=zCtrlWeatherID&&(zCtrlWeatherID=o,loadWeather())}}function decodeJalModeNow(e){switch(e){case 0:return"MANUAL";case 1:return"AUTO";case 2:return"USER LDR";default:return e}}function decodeCalorMode(e){switch(e){case 0:return"<div>NEDEFINIT</div>";case 1:return'<div class="green">DESCHIS</div>';case 2:return'<div class = "red">INCHIS</div>'}}function checkValueForBlink(e,t,a){var o=parseFloat(e);return o<t||o>a?"blink":""}function temp_resimtita(e,t,a){return parseFloat(e+t/100*.33*6.105*Math.exp(17.27*e/(237.7+e))-.7*a-4).toFixed(2)}function onVisibilityChange(){ERROR_INSTANCE=1,websocket.close(),location.replace("/protection")}function forceToEnableSND(){EN_SOUND||(DEBUG&&console.log("Try to enable SND..."),showInfoAutoClose(30,!1,"Activati sunetul in sistem pentru Alerte",function(){info.play(),info.pause(),short_info.play(),short_info.pause(),confirm_alert.play(),confirm_alert.pause(),EN_SOUND=!0,DEBUG&&console.log("Enable SND in SYSTEM")},null),setTimeout(function(){forceToEnableSND()},6e4))}function loadPageNonBlocking(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var e=JSON.parse(a.responseText);document.getElementById("idReloadWheater").innerHTML="[<b>"+e[0]+"</b>]: "+e[1],DEBUG&&console.log(response)}},a.send(),setTimeout(function(){a.abort()},t)}function LoadERRLST_EXTERMAL(){try{var e=new XMLHttpRequest;if(e.open("GET","https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/ERRLST.lst",!1),e.send(null),200!==e.status)return void(DEBUG&&console.log("ERRLST_EXTERMAL: can`t load"));var t=e.responseText;ERRLST_EXTERMAL=new Function("return "+t)(),DEBUG&&console.log("ERRLST_EXTERMAL Loaded OK")}catch(e){return void(DEBUG&&console.log("ERRLST_EXTERMAL Err: ",e.message))}}function checkDevice(){!1!==window.oldDevice&&$(".clsDevForOld").addClass("clsDevOld disabled")}$("#idReloadWheater").on("click",function(e){loadPageNonBlocking("http://upx83.go.ro/upx-center/wheather/vremea.php",5e3)}),$("#btn_turbo").on("click",function(e){setInterval(function(){showInfoAutoClose(10,!0,"Aceasta este o alerta <br> Acesta este randul doi<br>Randul trei",null,null)},2e4)}),setTimeout(function(){var e=document.createElement("script");e.src="https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/sound_library.js",document.body.appendChild(e),e.onload=function(){DEBUG&&console.log("sound_library OK"),forceToEnableSND()}},1e3);