var websocket,DEBUG=1,PAGENAME="",gateway="ws://"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/ws",websck_is_connected=!1,millis_esp=0,WSCONNECTED=0,RSSI=0,isLOCAL=0,ERROR_INSTANCE=(WSCONNECTED=0,0),EN_SOUND=!1,LAST_ERRID=-1,ERRLST_EXTERMAL=null,GET_DATA_THERMO=6,store_lista_ani={DateOfJson:"06.12.2025 22:08:23",index:["Heating","TMatrix","TLiving","TDormitor","TDormitor2"],labels:["22:08:23","22:08:24","22:08:25","22:08:26","22:08:27","22:08:28","22:08:29","22:08:30","22:08:31","22:08:32","22:08:33","22:08:34","22:08:35","22:08:36","22:08:37","22:08:38","22:08:39","22:08:40","22:08:41","22:08:42","22:08:43","22:08:44","22:08:45","22:08:46","22:08:47","22:08:48","22:08:49","22:08:50","22:08:51","22:08:52","22:08:53","22:08:54","22:08:55","22:08:56","22:08:57"],Heating:[!0,[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12]],TMatrix:[!1,[22,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25]],TLiving:[!1,[18,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25]],TDormitor:[!1,[16,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25,22.25]],TDormitor2:[!1,[25,22,40,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22.65,22.65,22.65,22.65,22.65,22.65,22.65,22.65]]};function onOpenWS(e){websck_is_connected=1,info_reboot_web(!1),setTimeout(pool_info_page,250),setTimeout(function(){checkMillis()},8e3),DEBUG&&console.log("Connection opened")}function onCloseWS(e){websck_is_connected=0,DEBUG&&console.log("Connection closed"),ERROR_INSTANCE||setTimeout(initWebSocket,2e3)}function initWebSocket(){DEBUG&&console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpenWS,websocket.onclose=onCloseWS,websocket.onmessage=onMessageWS}function onMessageWS(e){var o=JSON.parse(e.data);if(DEBUG&&console.log(o),1==o.hasOwnProperty("ERROR_INSTANCE"))return ERROR_INSTANCE=1,websocket.close(),o=null,alert("You have to many page opened. Keep only one in your in browser or slow down action!"),void location.replace("/protection");1==o.hasOwnProperty("cMs")&&(millis_esp=parseInt(o.cMs,10)),1==o.hasOwnProperty("Local")&&(isLOCAL=o.Local),1==o.hasOwnProperty("SIGNALPWR")&&(RSSI=o.SIGNALPWR),1==o.hasOwnProperty("wsCnt")&&(WSCONNECTED=o.wsCnt);var n=document.getElementById("idcMillis");if(n&&(n.innerHTML=millis_esp+" - ðŸ“¶ "+RSSI+"% ðŸ”´ LIVE ("+WSCONNECTED+")"),"thermostat"==PAGENAME&&(1==o.hasOwnProperty("QUICK_THERMO")&&parseParamThermo(o),null!==ERRLST_EXTERMAL&&1==o.hasOwnProperty("ERRLST_IDX"))){var t=parseInt(o.ERRLST_IDX,10);if(LAST_ERRID!=t)LAST_ERRID=t,showInfoAutoClose(10,!0,ERRLST_EXTERMAL[t],!1,null,null)}o=null}function pool_info_page(){if(!ERROR_INSTANCE&&websck_is_connected){var e={REQUEST_INFO:GET_DATA_THERMO},o=JSON.stringify(e);websck_is_connected&&websocket.send(o),o=null,e=null,websck_is_connected&&setTimeout(function(){pool_info_page()},2e3)}}function checkMillis(){if(!ERROR_INSTANCE){var e=millis_esp;void 0===checkMillis.lastMillis&&(checkMillis.lastMillis=0),e===checkMillis.lastMillis?(info_reboot_web(!0),setTimeout(function(){window.location.reload(!0)},3e3)):(checkMillis.lastMillis=e,setTimeout(checkMillis,5e3))}}function info_reboot_web(e){switch(e){case!0:$("#idNoConnexion").removeClass("hidden"),DEBUG&&console.log("Rebooting WebPage");break;case!1:$("#idNoConnexion").addClass("hidden")}}$(document).ready(function(){initWebSocket(),""==(PAGENAME=(PAGENAME=window.location.pathname).split("/").pop())&&(PAGENAME="index"),document.addEventListener("visibilitychange",onVisibilityChange),window.addEventListener("beforeunload",function(){document.removeEventListener("visibilitychange",onVisibilityChange)}),checkDevice(),$("#idPlsWait").removeClass("hidden"),setTimeout(function(){null==ERRLST_EXTERMAL&&LoadERRLST_EXTERMAL()},2e3),graphNow()});var confirmTimerId=null;function showInfoAutoClose(e,o,n,t,i){confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null);var l=document.getElementById("btnOkInfoAutoClose"),a=document.getElementById("btnCancelInfoAutoClose");if(document.getElementById("lblInfoAutoClose").innerHTML=n,autoFitText(),null===i?a.classList.add("hidden"):a.classList.remove("hidden"),$("#modalInfoAutoClose").modal("show"),e>0){var s=l.textContent.replace(/\s*\[\d+\]$/,"");r(),confirmTimerId=setInterval(function(){--e>0?r():(clearInterval(confirmTimerId),confirmTimerId=null,E())},1e3)}function r(){var o=e<10?"0"+e:e;l.textContent=s+" ["+o+"]"}function c(){l.removeEventListener("click",d),a.removeEventListener("click",E),confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null)}function d(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),t&&t()}function E(){c(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),i&&i()}EN_SOUND&&o&&myfavInfo.play(),l.addEventListener("click",d),a.addEventListener("click",E)}function secToDateTimeStr(e){if("number"!=typeof e||isNaN(e))return"Invalid";var o=Math.floor(e/86400),n=e%86400,t=Math.floor(n/3600);n%=3600;var i=Math.floor(n/60),l=n%60;function a(e){return e<10?"0"+e:e}var s="";return o>0&&(s+=o+"D "),s+=a(t)+":"+a(i)+":"+a(l)}function autoFitText(){var e=document.getElementById("lblInfoAutoClose"),o=50;for(e.style.fontSize=o+"px";e.scrollWidth>e.offsetWidth&&o>20;)o--,e.style.fontSize=o+"px"}function sendQuickAct(e){if(e&&0!==Object.keys(e).length){var o=JSON.stringify(e);DEBUG&&console.log("send->",o),websck_is_connected&&websocket.send(o),o=null,data=null}else DEBUG&&console.log("sendQuickAct:","err: no object to send!")}function parseParamThermo(e){if(null!=e){var o=e.QUICK_THERMO;$("#force24Thermo").prop("checked",o.THERMOSTATFORCE24),$("#idClimaForced").prop("checked",o.CLIMA_MODE),$("#THERMOSTAT").html(o.THERMOSTAT.toFixed(2)),$("#TEMP_DORMITOR").html(o.TEMP_DORMITOR.toFixed(2)),$("#TEMP_DORMITOR2").html(o.TEMP_DORMITOR2.toFixed(2)),$("#TEMP_HOL").html(o.TEMP_HOL.toFixed(2)),$("#TEMP_EXTERN").html(o.TEMP_EXTERN.toFixed(2)),$("#MATRIX_INDOOR").html(o.MATRIX_INDOOR.toFixed(2)),$("#THERMOSTAT").html(o.THERMOSTAT.toFixed(2)),$("#CentralaOn").html(o.CentralaOn?"DA":"NU"),$("#ClimaON").html(o.ClimaOn?"DA":"NU"),$("#TEMP_INDOOR_CALCULATION_METHOD").html(o.TEMP_INDOOR_CALCULATION_METHOD),$("#TURBO_HEAT_REM_TIME").html(secToDateTimeStr(o.TURBO_HEAT_REM_TIME)),$("#FORCED_CLIMA_REM_TIME").html(secToDateTimeStr(o.FORCED_CLIMA_REM_TIME)),$("#idPlsWait").addClass("hidden")}}function onVisibilityChange(){ERROR_INSTANCE=1,websocket.close(),location.replace("/protection")}function forceToEnableSND(){EN_SOUND||(DEBUG&&console.log("Try to enable SND..."),showInfoAutoClose(30,!1,"Activati sunetul in sistem pentru Alerte",function(){sndBtnClick.play(),sndBtnClick.pause(),myfavInfo.play(),myfavInfo.pause(),EN_SOUND=!0,DEBUG&&console.log("Enable SND in SYSTEM")},null),setTimeout(function(){forceToEnableSND()},6e4))}function LoadERRLST_EXTERMAL(){try{var e=new XMLHttpRequest;if(e.open("GET","https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/ERRLST.lst",!1),e.send(null),200!==e.status)return void(DEBUG&&console.log("ERRLST_EXTERMAL: can`t load"));var o=e.responseText;ERRLST_EXTERMAL=new Function("return "+o)(),DEBUG&&console.log("ERRLST_EXTERMAL Loaded OK")}catch(e){return void(DEBUG&&console.log("ERRLST_EXTERMAL Err: ",e.message))}}function checkDevice(){!1!==window.oldDevice&&$(".clsDevForOld").addClass("clsDevOld disabled").find("a").on("click",function(e){e.preventDefault()})}function graphNow(){if(null!=store_lista_ani){var e=document.getElementById("idGraphTemperature").querySelector("canvas"),o=e.getContext("2d");o.clearRect(0,0,e.width,e.height);var n={type:"line",data:{labels:[],datasets:[]},options:{animation:{easing:"linear",duration:1e3},maintainAspectRatio:!1,legend:{position:"bottom",display:!0,labels:{fontStyle:"normal",fontColor:"#ffffff"}},title:{fontStyle:"normal"},scales:{xAxes:[{gridLines:{color:"rgba(234, 236, 244, 0.5)",zeroLineColor:"rgba(234, 236, 244, 0.5)",drawBorder:!1,drawTicks:!0,borderDash:["1"],zeroLineBorderDash:["1"],drawOnChartArea:!0},ticks:{fontColor:"#ffcc1e",fontStyle:"normal",padding:20}}],yAxes:[{gridLines:{color:"rgba(234, 236, 244, 0.5)",zeroLineColor:"rgba(234, 236, 244, 0.5)",drawBorder:!1,drawTicks:!0,borderDash:["2"],zeroLineBorderDash:["2"]},ticks:{fontColor:"#ffcc1e",fontStyle:"normal",padding:20}}]}}},t=0,i=["rgba(142,223,78,0.05)","rgba(255,182,193,0.05)","rgba(173,216,230,0.05)","rgba(255,204,30,0.05)","rgba(255,30,233,0.05)"],l=["rgba(142,223,78,1.0)","rgba(255,182,193,1.0)","rgba(173,216,230,1.0)","rgba(255,204,30,1.0)","rgba(255,30,233,1.0)"];n.options.title={display:!0,text:store_lista_ani.DateOfJson.split(" ")[0],fontStyle:"normal",fontSize:17,fontColor:"#ffc700"},n.data.labels=store_lista_ani.labels,t=0,store_lista_ani.index.forEach(function(e){t<=5&&(n.data.datasets.push({label:e,fill:!0,steppedLine:store_lista_ani[e][0],pointRadius:1,pointHoverRadius:4,data:store_lista_ani[e][1],backgroundColor:i[t],borderColor:l[t],borderWidth:1}),t++)});new Chart(o,n)}else o.clearRect(0,0,e.width,e.height)}$("#force24Thermo").on("change",function(e){sendQuickAct({THERMOSTATFORCE24:$(this).is(":checked")}),sndBtnClick.play()}),$("#idClimaForced").on("change",function(e){var o=$(this).is(":checked");sendQuickAct({CLIMA_MODE:o=o?10:255}),sndBtnClick.play()}),setTimeout(function(){var e=document.createElement("script");e.src="https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/sound_library.js",document.body.appendChild(e),e.onload=function(){DEBUG&&console.log("sound_library OK")}},1e3);