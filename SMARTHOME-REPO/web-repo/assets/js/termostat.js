function updateHomeData(e){var t=JSON.parse(e);return[t.LIVE.THERMOSTAT,t.LIVE.MATRIX_INDOOR,t.LIVE.CentralaOn]}var thermostatDial=function(){function e(e,a,r){var i=document.createElementNS("http://www.w3.org/2000/svg",e);return t(i,a),r&&r.appendChild(i),i}function t(e,t){for(var a in t)e.setAttribute(a,t[a])}function a(e,t,a){var r=t*Math.PI/180,i=e[0]-a[0],s=e[1]-a[1];return[i*Math.cos(r)-s*Math.sin(r)+a[0],i*Math.sin(r)+s*Math.cos(r)+a[1]]}function r(e,t,r){return e.map(function(e){return a(e,t,r)})}function i(e){return e.map(function(e,t){return(t>0?"L":"M")+e[0]+" "+e[1]}).join(" ")+"Z"}function s(e,t,a){return["M",e,",",t,"m",0-a,",",0,"a",a,",",a,0,1,",",0,2*a,",",0,"a",a,",",a,0,1,",",0,0-2*a,",",0,"z"].join(" ").replace(/\s,\s/g,",")}function n(e,t,a){return e<t?t:e>a?a:e}function u(e){return Math.round(2*e)/2}function c(e,t,a){e.classList[a?"add":"remove"](t)}return function(d,o){var l=this,m={tickDegrees:300,rangeValue:(o={diameter:(o=o||{}).diameter||400,minValue:o.minValue||10,maxValue:o.maxValue||30,numTicks:o.numTicks||150,onSetTargetTemperature:o.onSetTargetTemperature||function(){}}).maxValue-o.minValue,radius:o.diameter/2,ticksOuterRadius:o.diameter/30,ticksInnerRadius:o.diameter/8,hvac_states:["off","heating","cooling"],dragLockAxisDistance:15};m.lblAmbientPosition=[m.radius,m.ticksOuterRadius-(m.ticksOuterRadius-m.ticksInnerRadius)/2],m.offsetDegrees=180-(360-m.tickDegrees)/2;var p={target_temperature:o.minValue,ambient_temperature:o.minValue,hvac_state:m.hvac_states[0],has_leaf:!1,away:!1};Object.defineProperty(this,"target_temperature",{get:function(){return p.target_temperature},set:function(e){p.target_temperature=n(u(+e),o.minValue,o.maxValue),j()}}),Object.defineProperty(this,"ambient_temperature",{get:function(){return p.ambient_temperature},set:function(e){p.ambient_temperature=u(+e),j()}}),Object.defineProperty(this,"hvac_state",{get:function(){return p.hvac_state},set:function(e){m.hvac_states.indexOf(e)>=0&&(p.hvac_state=e,j())}}),Object.defineProperty(this,"has_leaf",{get:function(){return p.has_leaf},set:function(e){p.has_leaf=!!e,j()}}),Object.defineProperty(this,"away",{get:function(){return p.away},set:function(e){p.away=!!e,j()}});for(var f,h,_,g,v=e("svg",{width:"100%",height:"100%",viewBox:"0 0 "+o.diameter+" "+o.diameter,class:"dial"},d),T=(e("circle",{cx:m.radius,cy:m.radius,r:m.radius,class:"dial__shape"},v),e("path",{d:(f=m.radius,h=m.radius,_=m.radius-4,g=m.radius-8,s(f,h,_)+" "+s(f,h,g)),class:"dial__editableIndicator"},v),e("g",{class:"dial__ticks"},v)),b=[[m.radius-1,m.ticksOuterRadius],[m.radius+1,m.ticksOuterRadius],[m.radius+1,m.ticksInnerRadius],[m.radius-1,m.ticksInnerRadius]],x=[[m.radius-1.5,m.ticksOuterRadius],[m.radius+1.5,m.ticksOuterRadius],[m.radius+1.5,m.ticksInnerRadius+20],[m.radius-1.5,m.ticksInnerRadius+20]],k=m.tickDegrees/o.numTicks,y=[],V=0;V<o.numTicks;V++)y.push(e("path",{d:i(b)},T));var M=e("text",{x:m.radius,y:m.radius,class:"dial__lbl dial__lbl--target"},v),S=document.createTextNode("");M.appendChild(S);var O=e("text",{x:m.radius+m.radius/2.5,y:m.radius-m.radius/8,class:"dial__lbl dial__lbl--target--half"},v),w=document.createTextNode("5");O.appendChild(w);var E=e("text",{class:"dial__lbl dial__lbl--ambient"},v),L=document.createTextNode("");E.appendChild(L);var A=e("text",{x:m.radius,y:m.radius,class:"dial__lbl dial__lbl--away"},v),P=document.createTextNode("AWAY");A.appendChild(P),e("path",{class:"dial__ico__leaf"},v);var R=m.radius/5/100,D=["M",3,84,"c",24,17,51,18,73,-6,"C",100,52,100,22,100,4,"c",-13,15,-37,9,-70,19,"C",4,32,0,63,0,76,"c",6,-7,18,-17,33,-23,24,-9,34,-9,48,-20,-9,10,-20,16,-43,24,"C",22,63,8,78,3,84,"z"].map(function(e){return isNaN(e)?e:e*R}).join(" "),I=[m.radius-100*R*.5,1.5*m.radius];function j(){v.classList[l.away?"add":"remove"]("away"),Array.prototype.slice.call(v.classList).forEach(function(e){e.match(/^dial--state--/)&&v.classList.remove(e)}),v.classList.add("dial--state--"+l.hvac_state),function(){var e,a;l.away?a=e=l.ambient_temperature:(e=Math.min(l.ambient_temperature,l.target_temperature),a=Math.max(l.ambient_temperature,l.target_temperature));var s=n(Math.round((e-o.minValue)/m.rangeValue*o.numTicks),0,o.numTicks-1),u=n(Math.round((a-o.minValue)/m.rangeValue*o.numTicks),0,o.numTicks-1);y.forEach(function(e,a){var n=a>=s&&a<=u;t(e,{d:i(r(a==s||a==u?x:b,a*k-m.offsetDegrees,[m.radius,m.radius])),class:n?"active":""})})}(),S.nodeValue=Math.floor(l.target_temperature),c(O,"shown",l.target_temperature%1!=0),function(){L.nodeValue=Math.floor(l.ambient_temperature),l.ambient_temperature%1!=0&&(L.nodeValue+=".5");var e=n(l.ambient_temperature,o.minValue,o.maxValue);degs=m.tickDegrees*(e-o.minValue)/m.rangeValue-m.offsetDegrees,e>l.target_temperature?degs+=8:degs-=8;var r=a(m.lblAmbientPosition,degs,[m.radius,m.radius]);t(E,{x:r[0],y:r[1]})}(),c(v,"has-leaf",l.has_leaf)}e("path",{class:"dial__ico__leaf",d:D,transform:"translate("+I[0]+","+I[1]+")"},v),j();var N,C={inProgress:!1,startPoint:null,startTemperature:0,lockAxis:void 0};function $(e){return e.targetTouches&&e.targetTouches.length?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:[e.x,e.y]}function J(e){N=setTimeout(function(){c(v,"dial--edit",!0),C.inProgress=!0,C.startPoint=$(e),C.startTemperature=l.target_temperature||o.minValue,C.lockAxis=void 0},500)}function Y(e){clearTimeout(N),c(v,"dial--edit",!1),C.inProgress&&(C.inProgress=!1,l.target_temperature!=C.startTemperature&&"function"==typeof o.onSetTargetTemperature&&o.onSetTargetTemperature(l.target_temperature))}function H(e){if(e.preventDefault(),C.inProgress){var t,a=$(e),r=C.startPoint[1]-a[1],i=a[0]-C.startPoint[0];"x"==C.lockAxis?t=i:"y"==C.lockAxis?t=r:Math.abs(r)>m.dragLockAxisDistance?(C.lockAxis="y",t=r):Math.abs(i)>m.dragLockAxisDistance?(C.lockAxis="x",t=i):t=Math.abs(r)>Math.abs(i)?r:i;var s=t*(o.diameter/d.clientWidth)/o.diameter*m.rangeValue;l.target_temperature=u(C.startTemperature+s)}}v.addEventListener("mousedown",J),v.addEventListener("touchstart",J),v.addEventListener("mouseup",Y),v.addEventListener("mouseleave",Y),v.addEventListener("touchend",Y),v.addEventListener("mousemove",H),v.addEventListener("touchmove",H)}}(),nest=new thermostatDial(document.getElementById("thermostat"),{onSetTargetTemperature:function(e){var t={act:"addTemperature",newTemp:+e};$.ajax({url:"../php/settings_param.php",type:"post",data:t,success:function(t){$("#replySave").html(t),nest.ambient_temperature<+e?nest.has_leaf=1:nest.has_leaf=0}})}});function saveSettings(e){var t=JSON.parse(e);if(null!=t){t.SYSTEM.THERMOSTATFORCE24="1";var a='{"act":"write","SYSTEM":'+JSON.stringify(t.SYSTEM)+"}",r=JSON.parse(a);$.ajax({url:"../php/settings_param.php",type:"post",data:r,success:function(e){$("#replySave").html(e)}})}}function UpdateSettings(){$.ajax({url:"../php/settings_param.php",type:"post",data:{act:"read"},success:function(e){saveSettings(e)}})}$.ajax({url:"../php/liveParamToJson.php",data:"",success:function(e){var t=updateHomeData(e);nest.target_temperature=t[0],nest.ambient_temperature=t[1];var a="true"===t[2].toLowerCase();nest.has_leaf=a?1:0}}),$("#btn_turbo").on("click",function(e){UpdateSettings()});