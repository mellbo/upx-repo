var websocket,DEBUG=1,PAGENAME="",gateway=window.location.port?`ws://${window.location.hostname}:${window.location.port}/ws`:`ws://${window.location.hostname}/ws`,websck_is_connected=!1,millis_esp=0,WSCONNECTED=0,RSSI=0,isLOCAL=0,ERROR_INSTANCE=(WSCONNECTED=0,0),EN_SOUND=!1,LAST_ERRID=-1,ERRLST_EXTERMAL=null,GET_DATA_THERMO=6;function onOpenWS(e){websck_is_connected=1,info_reboot_web(!1),setTimeout(pool_info_page,250),setTimeout(function(){checkMillis()},8e3),DEBUG&&console.log("Connection opened")}function onCloseWS(e){websck_is_connected=0,DEBUG&&console.log("Connection closed"),ERROR_INSTANCE||setTimeout(initWebSocket,2e3)}function initWebSocket(){DEBUG&&console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpenWS,websocket.onclose=onCloseWS,websocket.onmessage=onMessageWS}function onMessageWS(e){var o=JSON.parse(e.data);if(DEBUG&&console.log(o),1==o.hasOwnProperty("ERROR_INSTANCE"))return ERROR_INSTANCE=1,websocket.close(),o=null,alert("You have to many page opened. Keep only one in your in browser or slow down action!"),void location.replace("/protection");1==o.hasOwnProperty("cMs")&&(millis_esp=parseInt(o.cMs,10)),1==o.hasOwnProperty("Local")&&(isLOCAL=o.Local),1==o.hasOwnProperty("SIGNALPWR")&&(RSSI=o.SIGNALPWR),1==o.hasOwnProperty("wsCnt")&&(WSCONNECTED=o.wsCnt);var n=document.getElementById("idcMillis");if(n&&(n.innerHTML=millis_esp+" - ðŸ“¶ "+RSSI+"% ðŸ”´ LIVE ("+WSCONNECTED+")"),"thermostat"==PAGENAME&&(1==o.hasOwnProperty("QUICK_THERMO")&&parseParamThermo(o),null!==ERRLST_EXTERMAL&&1==o.hasOwnProperty("ERRLST_IDX"))){var t=parseInt(o.ERRLST_IDX,10);if(LAST_ERRID!=t)LAST_ERRID=t,showInfoAutoClose(10,!0,ERRLST_EXTERMAL[t],!1,null,null)}o=null}function pool_info_page(){if(!ERROR_INSTANCE&&websck_is_connected){var e={REQUEST_INFO:GET_DATA_THERMO},o=JSON.stringify(e);websck_is_connected&&websocket.send(o),o=null,e=null,websck_is_connected&&setTimeout(function(){pool_info_page()},2e3)}}function checkMillis(){if(!ERROR_INSTANCE){var e=millis_esp;void 0===checkMillis.lastMillis&&(checkMillis.lastMillis=0),e===checkMillis.lastMillis?(info_reboot_web(!0),setTimeout(function(){window.location.reload(!0)},3e3)):(checkMillis.lastMillis=e,setTimeout(checkMillis,5e3))}}function info_reboot_web(e){switch(e){case!0:$("#idNoConnexion").removeClass("hidden"),DEBUG&&console.log("Rebooting WebPage");break;case!1:$("#idNoConnexion").addClass("hidden")}}$(document).ready(function(){initWebSocket(),""==(PAGENAME=(PAGENAME=window.location.pathname).split("/").pop())&&(PAGENAME="index"),document.addEventListener("visibilitychange",onVisibilityChange),window.addEventListener("beforeunload",function(){document.removeEventListener("visibilitychange",onVisibilityChange)}),checkDevice(),$("#idPlsWait").removeClass("hidden"),setTimeout(function(){null==ERRLST_EXTERMAL&&LoadERRLST_EXTERMAL()},2e3)});var confirmTimerId=null;function showInfoAutoClose(e,o,n,t,i){confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null);var l=document.getElementById("btnOkInfoAutoClose"),s=document.getElementById("btnCancelInfoAutoClose");if(document.getElementById("lblInfoAutoClose").innerHTML=n,autoFitText(),null===i?s.classList.add("hidden"):s.classList.remove("hidden"),$("#modalInfoAutoClose").modal("show"),e>0){var c=l.textContent.replace(/\s*\[\d+\]$/,"");a(),confirmTimerId=setInterval(function(){--e>0?a():(clearInterval(confirmTimerId),confirmTimerId=null,d())},1e3)}function a(){var o=e<10?"0"+e:e;l.textContent=c+" ["+o+"]"}function r(){l.removeEventListener("click",E),s.removeEventListener("click",d),confirmTimerId&&(clearInterval(confirmTimerId),confirmTimerId=null)}function E(){r(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),t&&t()}function d(){r(),$("#modalInfoAutoClose").modal("hide"),$(".modal-backdrop").css("display","none"),$("body").removeClass("modal-open"),i&&i()}EN_SOUND&&o&&confirm_alert.play(),l.addEventListener("click",E),s.addEventListener("click",d)}function secToDateTimeStr(e){if("number"!=typeof e||Number.isNaN(e))return"Invalid";var o=Math.floor(e/86400),n=e%86400,t=Math.floor(n/3600);n%=3600;var i=Math.floor(n/60),l=n%60,s="";return o>0&&(s+=o+"D "),s+=String(t).padStart(2,"0")+":"+String(i).padStart(2,"0")+":"+String(l).padStart(2,"0")}function autoFitText(){var e=document.getElementById("lblInfoAutoClose"),o=50;for(e.style.fontSize=o+"px";e.scrollWidth>e.offsetWidth&&o>20;)o--,e.style.fontSize=o+"px"}function sendQuickAct(e){if(e&&0!==Object.keys(e).length){var o=JSON.stringify(e);DEBUG&&console.log("send->",o),websck_is_connected&&websocket.send(o),o=null,data=null}else DEBUG&&console.log("sendQuickAct:","err: no object to send!")}function parseParamThermo(e){if(null!=e){var o=e.QUICK_THERMO;$("#force24Thermo").prop("checked",o.THERMOSTATFORCE24),$("#idClimaForced").prop("checked",o.CLIMA_MODE),$("#THERMOSTAT").html(o.THERMOSTAT.toFixed(2)),$("#TEMP_DORMITOR").html(o.TEMP_DORMITOR.toFixed(2)),$("#TEMP_DORMITOR2").html(o.TEMP_DORMITOR2.toFixed(2)),$("#TEMP_HOL").html(o.TEMP_HOL.toFixed(2)),$("#TEMP_EXTERN").html(o.TEMP_EXTERN.toFixed(2)),$("#MATRIX_INDOOR").html(o.MATRIX_INDOOR.toFixed(2)),$("#THERMOSTAT").html(o.THERMOSTAT.toFixed(2)),$("#CentralaOn").html(o.CentralaOn?"DA":"NU"),$("#ClimaON").html(o.ClimaOn?"DA":"NU"),$("#TEMP_INDOOR_CALCULATION_METHOD").html(o.TEMP_INDOOR_CALCULATION_METHOD),$("#TURBO_HEAT_REM_TIME").html(secToDateTimeStr(o.TURBO_HEAT_REM_TIME)),$("#FORCED_CLIMA_REM_TIME").html(secToDateTimeStr(o.FORCED_CLIMA_REM_TIME)),$("#idPlsWait").addClass("hidden")}}function onVisibilityChange(){ERROR_INSTANCE=1,websocket.close(),location.replace("/protection")}function forceToEnableSND(){EN_SOUND||(DEBUG&&console.log("Try to enable SND..."),showInfoAutoClose(30,!1,"Activati sunetul in sistem pentru Alerte",function(){info.play(),info.pause(),short_info.play(),short_info.pause(),confirm_alert.play(),confirm_alert.pause(),EN_SOUND=!0,DEBUG&&console.log("Enable SND in SYSTEM")},null),setTimeout(function(){forceToEnableSND()},6e4))}function LoadERRLST_EXTERMAL(){try{var e=new XMLHttpRequest;if(e.open("GET","https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/ERRLST.lst",!1),e.send(null),200!==e.status)return void(DEBUG&&console.log("ERRLST_EXTERMAL: can`t load"));var o=e.responseText;ERRLST_EXTERMAL=new Function("return "+o)(),DEBUG&&console.log("ERRLST_EXTERMAL Loaded OK")}catch(e){return void(DEBUG&&console.log("ERRLST_EXTERMAL Err: ",e.message))}}function checkDevice(){!1!==window.oldDevice&&$(".clsDevForOld").addClass("clsDevOld disabled").find("a").on("click",function(e){e.preventDefault()})}$("#force24Thermo").on("change",function(e){sendQuickAct({THERMOSTATFORCE24:$(this).is(":checked")})}),$("#idClimaForced").on("change",function(e){$(this).is(":checked");sendQuickAct({CLIMA_MODE:10})}),setTimeout(function(){var e=document.createElement("script");e.src="https://mellbo.github.io/upx-repo/SMARTHOME-REPO/web-repo/assets/js/sound_library.js",document.body.appendChild(e),e.onload=function(){DEBUG&&console.log("sound_library OK"),forceToEnableSND()}},1e3);